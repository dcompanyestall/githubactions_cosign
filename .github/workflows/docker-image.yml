name: Cosign Image on Push
# Logs in to Docker Hub using GitHub secrets.
# Extracts metadata for better tagging
# Setup buildx to enable attestation support
# Builds and pushes the container image to docker hub, establishing provenance  
# Generates SLSA provenance

on:
  push:
    branches: [ "main" ]
    
permissions:
    contents: write
    packages: write
    id-token: write
    actions: write
    security-events: write

env:
  # Use docker.io for Docker Hub if empty
  # REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}
    
jobs:

  sign-and-verify:
    runs-on: ubuntu-latest   

    steps:
    - name: Checkout the repository code
      uses: actions/checkout@v4

    # Install the cosign tool except on PR
    # https://github.com/sigstore/cosign-installer
    - name: Install cosign
      uses: sigstore/cosign-installer@59acb6260d9c0ba8f4a2f9d9b48431a222b68e20 #v3.5.0
      with:
        cosign-release: 'v2.2.4'

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and Sign Image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:main .
        ./cosign sign --key ${{ secrets.COSIGN_KEY }} ${{ env.IMAGE_NAME }}:main
        docker push ${{ env.IMAGE_NAME }}:main

    - name: Verify Image Signature
      run: ./cosign verify --key ${{ secrets.COSIGN_PUB }} ${{ env.IMAGE_NAME }}:main
        
